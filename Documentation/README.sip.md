[Back to Main Readme](../README.md)

# Настройка работы с SIP

Для работы требуется SIP сервер, в данном примере используется `freeswitch`. Для совершения аудио-звонков используется минималистичный клиент `baresip`, с возможностью расширения функциональности внешними модулями или прямого управления другой программой.

### SIP-сервер
Пример конфигурационных файлов `freeswitch` расположен в `./_production/sip-server-configs-freeswitch/`, содержимое этой директории необходимо скопировать в `/etc/freeswitch/`.

В этой конфигурации уже настроены три sip-аккаунта: 1000, 1001, 1002. Пароль к каждому аккаунту установлен таким же как и логин (1000, 1001, 1002 соответственно).

Подразумевается использование с адресом сервера `192.168.0.105`, если адрес сервера или домен другие, требуется вручную изменить этот адрес в файлах:
```
dialplan/default/20-interconnect.xml
directory/private.xml
```

Для запуска сервера введите:
```
$ sudo mkdir /usr/local/freeswitch/var/run/freeswitch/;
$ sudo chown -R freeswitch:freeswitch /usr/local/freeswitch;
$ sudo chmod -R a+rw  /usr/local/freeswitch/var/run/freeswitch/;
$ sudo /usr/local/freeswitch/bin/freeswitch -u freeswitch -g freeswitch -c -nonat -rp
```
Для запуска в фоновом режиме вместо последней команды введите:
```
/usr/local/freeswitch/bin/freeswitch -u freeswitch -g freeswitch -ncwait -nonat -rp
```


### SIP-клиент
В прошивке используется клиент `baresip`, для его полноценной работы требуется исправить параметр module_path в файле `/etc/baresip/config` на:
```
module_path		/usr/lib/baresip/modules
```

Для настройки аккаунтов используется файл `/etc/baresip/accounts`. Следует закомментировать все строки примеров и добавить строку:
```
<sip:1001@192.168.0.105>;auth_pass=1001
```
В данном примере используется URI запись для sip-протокола: `<sip:логин@адрес-сервера>;auth_pass=пароль`

Для запуска sip-клиента необходимо воспользоваться командой:
```
baresip -f /etc/baresip 
```
Для управления можно пользоваться этой же консолью или подключиться к baresip используя telnet на порту 5555 (настраивается в `/etc/baresip/config` параметром `cons_listen`). 

Список команд и их сокращений выводится по нажатию Enter.
Для вызова удалённой стороны небходимо ввести `/dial` или просто букву `d` (нажатие Enter для сокращённых команд не требуется), после чего ввести адрес вызываемого абонента. Если абонент зарегистрирован на том же сервере, достаточно указать его логин и нажать Enter. Для поднятия трубки при входящем вызове достаточно нажать `a` (сокращение от answer). Для завершения звонка нажмите клавишу `b` (сокращение от break).


Таким образом, для совершения пробного звонка с сервера (ноутбука), на котором запущен сервер `freeswitch` запустите клиент `baresip`:
```
$ baresip
```
В запущенном ранее `baresip` клиенте на железке совершите вызов:  `d 1000`. В коносли клиента `baresip` на ноутбуке возьмите трубку  `a`.

